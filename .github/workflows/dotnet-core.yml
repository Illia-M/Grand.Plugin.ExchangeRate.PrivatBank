name: .NET Core

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  release:
    types:
      - created
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.301
    - name: Pull GrandNode
      run: |
        mkdir grandnode
        git clone https://github.com/grandnode/grandnode.git --branch Release-4.70 --single-branch grandnode
        mkdir grandnode/Plugins/Grand.Plugin.ExchangeRate.PrivatBank
    - name: List pulled GrandNode files
      run: |
        ls -la .
        ls -la grandnode
    - uses: actions/checkout@v2
      with:
        path: 'grandnode/Plugins/Grand.Plugin.ExchangeRate.PrivatBank'
    - name: List sources files
      run: |
        ls -la grandnode/Plugins/Grand.Plugin.ExchangeRate.PrivatBank
    - name: Install dependencies
      working-directory: grandnode/Plugins/Grand.Plugin.ExchangeRate.PrivatBank
      run: dotnet restore
    - name: Build
      working-directory: grandnode/Plugins/Grand.Plugin.ExchangeRate.PrivatBank
      run: dotnet build --configuration Release --no-restore
    - name: List release files
      run: ls -la grandnode/Grand.Web/Plugins/ExchangeRate.PrivatBank
    - name: Test
#      working-directory: grandnode/Plugins/Grand.Plugin.ExchangeRate.PrivatBank
#      run: dotnet test --no-restore --verbosity normal
      run: echo "To be done"
    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        name: GrandNode-ExchangeRate-PrivatBank
        path: 'grandnode/Grand.Web/Plugins/ExchangeRate.PrivatBank'
    - name: Zip Release
      uses: TheDoctor0/zip-release@0.4.1
      with:
        filename: 'GrandNode-ExchangeRate-PrivatBank.zip'
        directory: 'grandnode/Grand.Web/Plugins/ExchangeRate.PrivatBank'
        exclusions: '/refs/*'
    - name: Print Github REF
      run: echo $env:GITHUB_REF
    - name: Create release
      uses: djnicholson/release-action@v2.4
      if: github.ref == 'master'
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        release-name: 'Latest rolling build'
#        tag-name: 'v1.0'
        asset-name: 'GrandNode-ExchangeRate-PrivatBank.zip'
        file: 'grandnode/Grand.Web/Plugins/ExchangeRate.PrivatBank/GrandNode-ExchangeRate-PrivatBank.zip'
